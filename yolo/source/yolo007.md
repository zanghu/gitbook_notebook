## Yolo v3: 使用训练好的模型对单张图片进行检测

参考资料：[https://pjreddie.com/darknet/yolo/](https://pjreddie.com/darknet/yolo/)

### 1.数据加载机制概述

#### 1.1.动态训练数据加载

与现在常见的面向大型图像数据集的模型的样本加载策略类似，`darknet`在训练阶段也采用了“动态”加载样本数据的策略。

“动态”加载训练样本：每次将一个batch大小的训练数据读入内存，在模型用该batch训练后立即释放这部分内存。优点是节约内存，缺点是反复从硬盘读取数据造成性能上的I/O瓶颈。

“静态”加载训练样本：一次性将样本全部读入内存，在模型完成完整训练过程前不会将数据移出内存。优点是较高的I/O效率，缺点是不适用于数据量稍大的数据集。

#### 1.2.轮换式缓冲区设计

为了缓解动态训练数据加载方式I/O性能偏低的问题，`darknet`使用了两个大小相同的、用于存储加载到的训练数据的缓冲区。程序逻辑实现了在同一时刻，其中一个缓冲区中的数据被用于模型训练，另外一个缓冲区则正在加载下一次训练循环中用于训练数据。这样就提高了有限的I/O带宽的利用率。

### 2.基于多线程的数据加载策略

`darknet`数据加载模块采用基于`pthread`的多线程并发方式加载数据。这些线程按照任务性质的不同可以分为两类：

- 控制线程（1个）

- 工作线程（64个，写死在训练函数代码中不可配置）

控制线程的主要任务有二：

（1）对任务进行（尽可能地）均匀分配，为每个工作线程确定其需要加载的样本的个数和保存所加载到数据的内存区间；

（2）带所有工作线程结束后，汇总所有工作线程加载到的数据（汇总中移动的都是指向数据所在内存的指针，并未移动数据本身，所以速度应该很块）。

工作线程的主要任务包括：

（1）通过随机方式确定需要加载的训练样本图片的索引号；

（2）加载训练样本数据。

### 3.改进方向前瞻

#### 3.1.现有方式的不足之处

目前`darknet`在训练主循环（每一次循环共使用一个big batch的数据，每个子模型使用）中的每一次循环中都会执行一次数据加载，但是有两个值得改进的地方：

（1）数据加载相关的所有线程，包括控制线程和工作线程，都会被重新创建和销毁一次，似乎可以改造成线程池机制。