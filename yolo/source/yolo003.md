## Yolo v3: 源码分析——数据配置文件与数据加载

参考资料：[https://pjreddie.com/darknet/yolo/](https://pjreddie.com/darknet/yolo/)

### 1.两个配置文件

YOLO各版本一直以来都使用两个（类）配置文件：

- 数据配置文件：用于指明样本和真值信息的位置，模型参数保存路径和模型输出结果保存路径等。

- 网络结构配置文件: 指明网络的整体结构、优化算法和每一层的结构

#### 1.1.数据配置文件

数据配置文件有以下特点：

- 数据配置文件内容相对较少。

- 数据配置文件推荐以`.data`作为数据配置文件的后缀名，例如：YOLOv3的训练配置文件`voc.data`和ctw-baseline的`chinese.data`。

- 数据配置文件不包含以下内容：（1）预处理、样本增强、batch大小相关的信息；（2）不直接包含样本真值信息的路径（darknet默认样本图片路径与对应的真值信息文件的路径存在映射规则，训练时根据该规则有样本图片路径推断真值信息文件路径）；（3）不包含样本尺寸相关的信息（darknet的样本图片加载模块可以直接）

### 2.数据加载模块和数据格式

机器学习模型的训练数据一般都要经过各种加工处理之后，才能制作成符合模型要求的输入数据格式。对于图片数据，各种预处理（缩放、像素值归一化等）和样本增强（平移、翻转、裁剪等等）也是必不可少的。

在`darknet`中，数据加工分为两部分：

- **STEP 1**: 由原始数据集生成符合`darknet`（数据加载器）要求格式的训练样本和真值信息，这步由`darknet`用户负责实现。

- **STEP 2**: 有输入数据生成内存中的模型输入数据，这步由`draknet`的数据加载器负责完成。

#### 2.1.从原始数据集到输入数据文件

- 生成`darknet`数据加载器要求的数据文需要的工作包括：
（1）将训练样本图片和真值信息文件按照指定目录格式和命名方式放置；
（2）确保样本图片的后缀名是`darknet`支持的格式；
（3）生成每个训练样本的真值信息文件；

- `darknet`数据加载器要求的数据格式：

##### 2.1.1.图片样本格式

图片分辨率不限，甚至不要求所有图片服从某个统一的分辨率；

图片后缀名必须是`.jpg`、`.png`、`.JPG`或`.JPEG`中之一；
    
如果编译`darknet`时打开了`OPENCV`选项，那么原则上应保证图片能够被OpenCV正确加载。

##### 2.1.2.真值信息文件格式

每张样本图片对应一个真值信息文件；

真值信息文件的名称应该与对应样本图片名称保持一致，但是后缀名换成`.txt`；

真值信息文件中每行是5个用空格分隔的数字，用来描述样本图的一个bbox；

每一行五元组含义是（id, bbox中心点x, bbox中心点y, bbox宽度, bbox高度）；

每一行五元组中后四元(x, y, w, h)的值并不是像素绝对值，而是相对于当前样本图片的边长的浮点数。即: ((x_bbox_center - bbox_left)/w_img, (y_bbox_ceter - bbox_up)/h_img, w_bbox/w_img, h_bbox/h_img)。这样做的好处是：将拟合值的取值范围压缩到[0, 1]。

每一行五元组中的id表示当前行所描述的bbox的类标编号，至少ctw-baseline在生成数据时是这么做的。

##### 2.1.3.实际例子

- **真值信息文件的例子**

ctw-baseline的真值信息文件的实例如下(文件名称：0000172_6_0.txt， 对应样本名称：0000172_6_0.jpg）:

```
47 0.900858 0.287963 0.131950 0.228359
266 0.064299 0.246023 0.133742 0.228904
811 0.252052 0.246023 0.190325 0.228904
145 0.214759 0.962409 0.069443 0.081863
45 0.275200 0.962620 0.051439 0.080559
173 0.325353 0.962789 0.048867 0.079520
172 0.375506 0.962954 0.051439 0.078498
95 0.426945 0.963125 0.051439 0.077441
116 0.480957 0.963305 0.051439 0.076331
147 0.532396 0.963477 0.051439 0.075274
```

上述文件每一行内容是对样本图片的一个bbox的描述，（bbox类标编号, x, y, w, h）

- 样本和真值信息目录结构实例，仍然以ctw-baseline为例：

```
products/trainval/xxx.jpg
products/trainval/xxx.txt
```

darknet允许类标文件和样本文件不在同一个目录下，但是二者所在目录字符串相差的词只能是符合下表的对应关系的那些：

| 图片目录中的被替换词 | 类标目录中的替换词 |
| :---: | --- |
| images | labels |
| JPEGImages | labels |
| raw | labels |

例如下面的样本图片和真值文件布置路径也是`darknet`允许的：

```
products/trainval/images/xxx.jpg
products/trainval/labels/xxx.txt
```

##### 2.2.darknet数据加载模块

`darknet`的数据加载模块有多个数据加载函数（`src/data.c`中的`load_thread()`函数中进行选择），根据任务所需的数据类型（定义在`darknet.h`中的枚举类型`data_type`）来确定采用哪个函数加载数据。

根据所加载的数据类型的不同，又可以分为图片数据加载函数族和真值信息文件加载函数族。

究竟什么样的任务应该选择哪个数据类型值，是一件尚未研究清楚的事。根据对源码的阅读，训练时使用`DETECTION_DATA`，而使用训练好的模型检测单张图片时使用`LETTERBOX_DATA`。

##### 2.2.1.图片数据加载

这里只研究·src/detector.c·中的`train_detector()`函数的图片数据加载过程，并且假定用户编译时开启了`OPENCV`编译选项。

- 数据加载函数调用链

load_data_detection -> load_image_color + jitter + random_distort_image

(1) load_image_color: 读取样本图片，在opencv模式下使用`cv::imread`读取图片，之后将读取到的数据转换为`darknet`的`image`对象。

转换过程：*.jpg图片 -> `cv::Mat`对象 -> `cv::IplImage`对象 -> `image`对象

(2) jitter: load_data_detection中的部分代码和`place_image()`函数共同实现了jitter，关于darknet中的jitter操作详情后续会专门论述；

(3) random_distort_image: 将图片表示变换到HSV颜色空间中，,s,v三通道上在添加噪声扰动。

最终得到的内存中的`image`对象的特性：每张图片轴向是(c, 0, 1)，其中"c"轴的三个元的顺序是BGR，像素值是闭区间[0, 1]之间的浮点数（归一化用的是除以255）。

##### 2.2.2.真值信息文件加载

真值信息文件加载过程: `src/data.c`中的函数：

```c
void fill_truth_detection(char *path, int num_boxes, float *truth, int classes, \
                          int flip, float dx, float dy, float sx, float sy);
```

加载真值信息时的处理中需要注意的包括以下几个：

（1）对每个样本的bbox随机乱序；
（2）你找加载对应样本时的随机样本增强操作，对bbox信息进行必要的变换；
（3）按照网络配置文件中的配置，限制每个样本的bbox个数。

##### 2.3.darknet内存数据格式

内存数据格式是指经过darknet的数据加载模块加载到内存中，准备输入给为网络的第一层的（内存中）数据格式。

（1）图片样本格式: 容器，轴向，取值（[0-1]浮点数），预处理流程。

（2）真值信息格式：bbox表示方式（中心坐标长宽），相对坐标，每个文件说明一个样本，文件每行五个数说明一个bbox。真值信息也按照样本增强的方式进行了必要的变换。

