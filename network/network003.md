## 端口详解


参考资料：[知乎：网络编程（六）：端口那些事儿](https://zhuanlan.zhihu.com/p/20365900)

### 端口是TCP和UDP协议的概念，但端口不是IP协议的一部分。

端口被设计出来主要是为了给协议栈和应用对应：

* 协议栈用端口号将数据分配给不同的应用层程序
* 应用层程序用端口号去区分不同的连接，参见之前提到过的“四元组”

TCP和UDP协议都使用了端口号（Port number）的概念来标识发送方和接收方的应用层。 对每个TCP连接的一端都有一个相关的16位的无符号端口号分配给它们。 即使是UDP这种没有连接的协议，依旧有一个16位的无符号端口号。 可能的、被正式承认的端口号有 2^16 -1 = 65535 个。

### 三类端口

端口被分为三类：著名端口、监听端口和动态端口。

* **著名端口**

著名端口是由因特网赋号管理局（IANA）来分配的，并且通常被用于系统进程。 IANA对于端口号的分配见这里 Service Name and Transport Protocol Port Number Registry 。 系统的/etc/services也有相应端口和服务名的对应，主要是用来给netstat、nmap 等系统命令做端口名反解用。

著名的应用程序作为服务器程序来运行，并侦听经常使用这些端口的连接。 这些端口的一个显著特征就是限定在0~1023，并且在Linux、UNIX平台均需要 Root权限才能监听这些端口。

在UNIX刚刚兴起的年代，服务器资源是十分稀缺的， 通常一台服务器上会有很多的用户，同时这台服务器往往还兼任一个学院、公司的邮件、 网站等服务。为了保证这些服务的端口不被普通用户占用， 当时UNIX的设计者就把使用这些端口的权限限制在系统管理员(Root)手里。

常见的`著名端口`有：FTP:21、SSH:22、SMTP:25、HTTP:80、HTTPS:443等。
监听端口通常被用来运行各种用户自己写的服务，服务监听在这些端口下不需要特别的权限。

* **监听端口**

BSD使用的监听端口范围是1024到4999。
IANA建议49152至65535作为“监听端口”。
许多Linux内核使用32768至61000范围。 配置文件 /proc/sys/net/ipv4/ip_local_port_range 有当前系统设定。

* **动态端口**

动态端口通常被用来在主动发起连接时随机分配使用，在任何特定的TCP连接外不具有任何意义。 这是由于TCP等协议是通过四元组来区分不同的网络连接。 当本机主动发起TCP连接的时候如果目的IP、目的端口、本地IP都是一样的， 只能通过占用不同的本地端口来区分不同的连接。

0~65535除去上述著名端口、监听端口两种端口号，剩下的端口都是备用的动态端口。 所以在某些特殊用途的需要主动发起大量连接的服务器上（例如：爬虫、代理）， 需要调整 /proc/sys/net/ipv4/ip_local_port_range 的数值，来保留更多的 动态端口以供使用。

* **0号端口**

端口号里有一个极为特殊的端口，各种文档书籍中都鲜有记载，就是0号端口。

在IANA官方的标准里0号端口是保留端口。


也就是说无论是TCP还是UDP网络通信，0号端口都是不能使用的。

然而，标准归标准，在UNIX/Linux网络编程中0号端口被赋予了特殊的涵义：

如果在bind绑定的时候指定端口0，意味着由系统随机选择一个可用端口来绑定。