## C: Linux环境动态库概述

参考资料：[Can someone explain about Linux library naming?](https://stackoverflow.com/questions/663209/can-someone-explain-about-linux-library-naming)

### 1.动态库与共享库的产生

静态库的概念产生于汇编语言时代，动态库的概念被完全接受则要相对迟很多。

#### 1.1 资源共享需求

动态库的概念的出现和被接受与多任务操作系统的出现密不可分，因为在多任务操作系统时代，资源（在多任务间）共享才变得重要起来。

典型的共享资源包括键盘、鼠标、显卡、声卡、网卡等。如果每个想访问共享资源的应用程序都要包含访问资源的控制代码（源代码或静态库），那么系统会由于存储重复的代码而变得效率低下，同时会造成存储资源（内存和硬盘）的浪费。

更好更高效的资源共享机制于是产生动态库的根本动力，也正因如此Linux下的动态库往往又被称为共享库。

#### 1.2 动态库发展历史

* **静态库**：典型的构建期链接；

* **早期动态库**：实现装载期链接. 硬盘上只存储一份库文件，每个用到该库的程序在运行启动时的装载期链接该库，每个程序的内存中都包含一份动态库的实体. 装载期链接解决了同一份库存储多次浪费硬盘空间的问题，但没有解决内存中同一份库重复存在浪费内存的问题。

这一代动态库的核心技术是装载时重定位（Load Time Relocation, LTR）

* **现代动态库**：实现运行期链接. 硬盘上之存储一份库文件，内存中也只有一份库文件实体，每个用到该动态库的程序在运行器通过运行期链接共享内存中的动态库。该方案同时解决了内存浪费和硬盘浪费。

这一代动态库的核心技术是位置无关代码（Position Independent Code, PIC），其实现依赖于虚拟内存技术，同时PIC技术又是现代多任务操作系统成功实现的基础。

#### 2.动态库的特点以及与静态库的区别

* 动态库已经完成了重定位（根据指令相对位置），所欠缺的只是装载期或运行期的二次重定位（根据虚地址空间的绝对地址）；静态库则是一系列未经任何重定位的目标文件的归档。

* 动态库在文件结构上更接近于可执行文件而不是静态库文件。事实上，Linux下允许制作可执行的动态库文件。

* 静态库一般被看作库使用者程序的一部分，使用静态库意味着使用者有责任管理静态库的符号、处理可能的符号冲突。动态库则更多的被看作是一个模块，强调封装性——模块的接口与实现相分离，模块的提供者应该负责控制发布的模块暴露哪些符号、隐藏哪些符号。

#### 3.动态库编译参数

编译目标文件时一般需要加入`-fPIC`参数，效果是告诉编译器生成位置无关代码。

生成动态库时一般需要加入`-shared`参数，效果是告诉编译器生成共享库。

#### 4.动态库的链接方式

现代程序对于链接时机有三种选择：（1）构建期链接（静态链接）；（2）装载期链接（动态链接方式1）；（3）运行期链接（动态链接方式2）。

Linux环境下C语言实现运行期链接依靠的是`dlopen`、`dlsym`和`dlclose`等函数。




